<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">

<html>
<head>
    <title>Time Series Analysis</title>
    <link type="text/css" href="../css/cupertino/jquery-ui-1.8.16.custom.css" rel="stylesheet"/>
    <link type="text/css" href="../css/dissector.css" rel="stylesheet"/>
    <script type='text/javascript' src='../js/jquery-1.7.min.js'></script>
    <script type='text/javascript' src='../js/highstock-1.0.1.js'></script>
    <script type="text/javascript" src="../js/jquery-ui-1.8.16.custom.min.js"></script>

    <script type='text/javascript'>
        var chart;
        $(document).ready(function() {
            chart = new Highcharts.StockChart({
                chart: {
                    renderTo: 'container'
                },
                rangeSelector: {
                    selected: 1
                },
                rangeSelector: {
                    buttons: [
                        { type: 'day', count: 1, text: '1d'},
                        { type: 'all', text: 'All'}
                    ]},
                //Setting null series
                series: [
                    {data:[]},
                    {data:[]}
                ]
            });

            $('#render1, #render2').button();
            $('#start,#stop').datepicker({ dateFormat: 'yy-mm-dd' });

            $('#render1').click(function() {
                chart.series[0].setData([]);
                chart.redraw();
                renderData(chart.series[0],
                        $('#ta1').val(),
                        $('#start').val(),
                        $('#stop').val());
            });

            $('#render2').click(function() {
                chart.series[1].setData([]);
                chart.redraw();
                renderData(chart.series[1],
                        $('#ta2').val(),
                        $('#start').val(),
                        $('#stop').val());
            });
        });

        function renderData(series, equation, start, stop) {
            var start = new Date(start + 'T00:00:00.000');
            var stop = new Date(stop + 'T23:59:59.000');
            var current = new Date(start.getTime() + 300000);
            var socket = new WebSocket('ws://localhost:1081/1.0/metric/get');

            socket.onopen = function() {
                console.info("Socket opened");
                socket.send('{"expression":"' + equation + '","start":"' + start.toISOString() + '", "stop": "' + current.toISOString() + '", "step": 300000}');
            };

            socket.onmessage = function(event) {
                console.info(event.data);
                var d = $.parseJSON(event.data);
                var point = [(new Date(d.time)).getTime(), d.value];
                series.addPoint(point);

                if (current.getTime() < stop.getTime()) {
                    var next = new Date(current.getTime() + 300000);
                    socket.send('{"expression":"' + equation + '","start":"' + current.toISOString() + '", "stop": "' + next.toISOString() + '", "step": 300000}');
                    current = next;
                } else {
                    console.info("Closing socket");
                    socket.close();
                }
            };
        }
    </script>
</head>
<body>
<div id='container' style='width: 100%; height: 400px'></div>
<div class='containerWrapper'>
    <div id='options' class='optionsGroup'>
        <div>Start <input type='text' id='start'></div>
        <div>Stop <input type='text' id='stop'></div>
    </div>
    <div id='series' class='seriesGroup'>
        <div id='series1'>
            <div>
                <textarea id='ta1' cols='80' rows='3'></textarea>
                <br/>
                <input id='render1' type='button' value='Render'/>
            </div>
        </div>
        <div id='series2'>
            <div>
                <textarea id='ta2' cols='80' rows='3'></textarea>
                <br/>
                <input id='render2' type='button' value='Render'/>
            </div>
        </div>
    </div>
</div>
</body>
</html>
