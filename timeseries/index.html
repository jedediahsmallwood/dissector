<html>
<head>
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js" type="text/javascript"></script>
  <script src="../js/highstock1.0.1/highstock.js" type="text/javascript"></script>
  <script>
    var chart;
    $(document).ready(function() {
      chart = new Highcharts.StockChart({
        chart: {
          renderTo: 'container'
        },
        rangeSelector: {
          selected: 1
        },
        rangeSelector: {
          buttons: [ 
            { type: 'day', count: 1, text: '1d'},
            { type: 'all', text: 'All'}
          ]},
         //Setting null series
         series: [{data:[]},{data:[]}]
       });

       $('#render1').click(function() {
           chart.series[0].setData([]);
           chart.redraw();
           renderData(chart.series[0], $('#ta1').val());
	 });
 
       $('#render2').click(function() {
           chart.series[1].setData([]);
           chart.redraw();
           renderData(chart.series[1], $('#ta2').val());
         });
    });

       function renderData(series, equation) {
         var start = new Date('2011-10-29T10:00:00.000Z');
         var stop = new Date('2011-10-29T23:59:59.000Z');
         var current = new Date(start.getTime() + 300000);
         var socket = new WebSocket('ws://localhost:1081/1.0/metric/get');

         socket.onopen = function() {
           console.info("Socket opened");
           socket.send('{"expression":"' + equation +'","start":"' + start.toISOString() +'", "stop": "' + current.toISOString() + '", "step": 300000}');
         };
        
         socket.onmessage = function(event) {
           console.info(event.data);
           var d = $.parseJSON(event.data);
           var point = [(new Date(d.time)).getTime(), d.value];
           series.addPoint(point);
           
           if( current.getTime() < stop.getTime() ) {
             var next = new Date(current.getTime() + 300000);
             socket.send('{"expression":"' + equation + '","start":"' + current.toISOString() +'", "stop": "' + next.toISOString() + '", "step": 300000}');
             current = next;
           } else {
             console.info("Closing socket");
             socket.close();
           }
         };
       }
  </script>
</head>
<body>
  <div id="container" style="width: 100%; height: 400px"></div>
  <textarea id="ta1" cols="80" rows="3"></textarea>  
  <input id="render1" type="button" value="Render"/>
  <p>
  <textarea id="ta2" cols="80" rows="3"></textarea>
  <input id="render2" type="button" value="Render"/>
</body>
</html>
