<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">

<html>
<head>
    <title>Historic</title>
    <link type="text/css" href="../css/cupertino/jquery-ui-1.8.16.custom.css" rel="stylesheet"/>
    <link type="text/css" href="../css/dissector.css" rel="stylesheet"/>
    <script type='text/javascript' src='../js/jquery-1.7.min.js'></script>
    <script type='text/javascript' src='../js/highstock-1.0.1.js'></script>
    <script type='text/javascript' src='../js/exporting-1.0.1.js'></script>
    <script type="text/javascript" src="../js/jquery-ui-1.8.16.custom.min.js"></script>

    <script type='text/javascript'>
        var chart;
        $(document).ready(function() {
            chart = new Highcharts.StockChart({
                chart: {
                    renderTo: 'chart'
                },
                rangeSelector: {
                    selected: 1
                },
                rangeSelector: {
                    buttons: [
                        { type: 'day', count: 1, text: '1d'},
                        { type: 'all', text: 'All'}
                    ]},
                legend: {
                    enabled: true,
                    verticalAlign: "top"
                },
                exporting: {
                    width: 1024,
                    filename: "historic",
                    type: "image/png"
                },
                series: [
                    {name: 'Series 1', data:[], id: 'series1'},
                    {name: 'Series 2', data:[], id: 'series2'},
                    {name: 'Series 3', data:[], id: 'series3'},
                    {name: 'Series 4', data:[], id: 'series4'},
                    {name: 'Series 5', data:[], id: 'series5'},
                    {name: 'Series 6', data:[], id: 'series6'}
                ]
            });

            $('#render1, #render2, #render3, #render4, #render5, #render6').button();
            $('#progressbar1, #progressbar2, #progressbar3, #progressbar4, #progressbar5, #progressbar6').progressbar({ disabled: true });

            $('#start').datepicker({ dateFormat: 'yy-mm-dd',
                onClose: function(dateText, inst) {
                    var stopVal = $('#stop');
                    if (dateText != '' && $('#stop').val() == '') {
                        $('#stop').val(dateText);
                    }
                }});
            $('#stop').datepicker({ dateFormat: 'yy-mm-dd'});

            $('#render1').click(function() {
                chart.series[0].setData([]);
                chart.redraw();
                renderHistoricData(chart.series[0],
                        $('#ta1').val(),
                        $('#start').val(),
                        $('#stop').val(),
                        $('#interval').val(),
                        $('#shift').val(),
                        $('#progressbar1'));
            });


            $('#render2').click(function() {
                chart.series[1].setData([]);
                chart.redraw();
                renderHistoricData(chart.series[1],
                        $('#ta2').val(),
                        $('#start').val(),
                        $('#stop').val(),
                        $('#interval').val(),
                        $('#shift').val(),
                        $('#progressbar2'));
            });

            $('#render3').click(function() {
                chart.series[2].setData([]);
                chart.redraw();
                renderHistoricData(chart.series[2],
                        $('#ta3').val(),
                        $('#start').val(),
                        $('#stop').val(),
                        $('#interval').val(),
                        $('#shift').val(),
                        $('#progressbar3'));
            });

            $('#render4').click(function() {
                chart.series[3].setData([]);
                chart.redraw();
                renderHistoricData(chart.series[3],
                        $('#ta4').val(),
                        $('#start').val(),
                        $('#stop').val(),
                        $('#interval').val(),
                        $('#shift').val(),
                        $('#progressbar4'));
            });

            $('#render5').click(function() {
                chart.series[4].setData([]);
                chart.redraw();
                renderHistoricData(chart.series[4],
                        $('#ta5').val(),
                        $('#start').val(),
                        $('#stop').val(),
                        $('#interval').val(),
                        $('#shift').val(),
                        $('#progressbar5'));
            });

            $('#render6').click(function() {
                chart.series[5].setData([]);
                chart.redraw();
                renderHistoricData(chart.series[5],
                        $('#ta6').val(),
                        $('#start').val(),
                        $('#stop').val(),
                        $('#interval').val(),
                        $('#shift').val(),
                        $('#progressbar6'));
            });
        });

        function renderHistoricData(series, equation, start, stop, interval, shift, progressbar) {
            var start = new Date(start + 'T00:00:00.000');
            var stop = new Date(stop + 'T23:59:59.000');
            var interval = parseInt(interval);
            var shift = parseInt(shift) * 1000;
            var currentTime = start.getTime() + interval;
            var current = new Date(start.getTime() + interval);
            var socket = new WebSocket('ws://localhost:1081/1.0/metric/get');

            progressbar.show('blind');
            progressbar.progressbar("option", "disabled", false);
            progressbar.progressbar("option", "value", 0);

            var totalMetrics = Math.round((stop.getTime() - start.getTime()) / interval);
            var observedMetrics = 0;

            socket.onopen = function() {
                console.info("Socket opened");
                socket.send('{"expression":"' + equation + '","start":"' + start.toISOString() + '", "stop": "' + current.toISOString() + '", "step": ' + interval + '}');
            };

            socket.onmessage = function(event) {
                var d = $.parseJSON(event.data);
                var point = [(new Date(d.time)).getTime() + shift, d.value];
                series.addPoint(point);

                observedMetrics++;
                progressbar.progressbar("option", "value", Math.round((observedMetrics / totalMetrics) * 100));

                if (current.getTime() < stop.getTime()) {
                    var next = new Date(current.getTime() + interval);
                    socket.send('{"expression":"' + equation + '","start":"' + current.toISOString() + '", "stop": "' + next.toISOString() + '", "step": ' + interval + '}');
                    current = next;
                } else {
                    console.info("Closing socket");
                    socket.close();
                    progressbar.progressbar("option", "disabled", true);
                    progressbar.hide('blind');
                    chart.redraw();
                }
            };
        }
    </script>
</head>
<body>
<div class='banner'><a href='../index.html'>Dissector</a> - Historic</div>
<div id='chart' style='width: 100%; height: 400px'></div>
<div class='containerWrapper'>
    <div id='options' class='optionsGroup'>
        <div>Start <input type='text' id='start'></div>
        <div>Stop <input type='text' id='stop'></div>
        <div>
            Interval
            <select id='interval'>
                <option value="300000">5 minutes</option>
                <option value="3600000">1 hour</option>
                <option value="86400000">1 day</option>
            </select>
        </div>
        <div>Shift <input type='text' id='shift' value='0'></div>
    </div>
    <div id='series' class='seriesGroup'>
        <div class='seriesColumn'>
            <div id='series1'>
                <h3>Series 1</h3>

                <div>
                    <textarea id='ta1' rows='3'></textarea>
                    <br/>

                    <div id="progressbar1"></div>
                    <input id='render1' type='button' value='Render'/>
                </div>
            </div>
            <div id='series2'>
                <h3>Series 2</h3>

                <div>
                    <textarea id='ta2' rows='3'></textarea>
                    <br/>

                    <div id="progressbar2"></div>
                    <input id='render2' type='button' value='Render'/>
                </div>
            </div>
            <div id='series3'>
                <h3>Series 3</h3>

                <div>
                    <textarea id='ta3' rows='3'></textarea>
                    <br/>

                    <div id="progressbar3"></div>
                    <input id='render3' type='button' value='Render'/>
                </div>
            </div>
        </div>
        <div class='seriesColumn'>
            <div id='series4'>
                <h3>Series 4</h3>

                <div>
                    <textarea id='ta4' rows='3'></textarea>
                    <br/>

                    <div id="progressbar4"></div>
                    <input id='render4' type='button' value='Render'/>
                </div>
            </div>
            <div id='series5'>
                <h3>Series 5</h3>

                <div>
                    <textarea id='ta5' rows='3'></textarea>
                    <br/>

                    <div id="progressbar5"></div>
                    <input id='render5' type='button' value='Render'/>
                </div>
            </div>
            <div id='series6'>
                <h3>Series 6</h3>

                <div>
                    <textarea id='ta6' rows='3'></textarea>
                    <br/>

                    <div id="progressbar6"></div>
                    <input id='render6' type='button' value='Render'/>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
</html>
